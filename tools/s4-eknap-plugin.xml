<?xml version="1.0" encoding="UTF-8"?>
<!-- Viser et E-Knap ikon for adresser og matrikler returneret fra geosearch -->

<!-- https://github.com/Septima/spatialsuite-s4/issues/39 -->

<!-- LÃ¦s om s4's API her: -->
<!-- https://github.com/Septima/spatialsuite-s4/wiki/S4-API -->

<tool type="plugin">
    <requires>
	    [if: ModuleDefined("s4") ]
	    	<include src="[module:s4.dir]/tools/s4-requires.xml" nodes="/tool/requires/*" mustexist="true"/>
		[endif]
   </requires>
    <src/>
    <jssrc><![CDATA[
	    [if: ModuleDefined("s4") ]
            
            if (typeof eknap_infoHandler !== 'undefined'){
	           	var _s4CustomButtons = _s4CustomButtons || [];    // Brug eksisterende array eller skab en ny

	           	var _s4eKnapUri = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAARCAYAAAA7bUf6AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYxIDY0LjE0MDk0OSwgMjAxMC8xMi8wNy0xMDo1NzowMSAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNS4xIFdpbmRvd3MiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6MEQ4NUYzM0IwN0U2MTFFMkI4RkM5QkVGN0YxQUFCNUYiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6MEQ4NUYzM0MwN0U2MTFFMkI4RkM5QkVGN0YxQUFCNUYiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDowRDg1RjMzOTA3RTYxMUUyQjhGQzlCRUY3RjFBQUI1RiIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDowRDg1RjMzQTA3RTYxMUUyQjhGQzlCRUY3RjFBQUI1RiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PiIQiWAAAADHSURBVHjapFTbEYQgDDR4YyM0QDtngbZjBdbAtzxPP5IJQRz08gOTwGbZzQA55+HfAAQxxixVEWA467hibl3XmZ/74GYcR0rixZv9iQh4Xl3SA6oPSqmCxVUQk5QS0T7ofp9oQiAxRtkJHoN475t0u93RWlfuXIm6bdvcZLLveyUeF5TNU5ZPJRDnXNW1dxALTTCste/c4SCv3Qkh3A5UlzvTNC1cC75Ktw795ubE8kt8gqXt0qECRAbP3T0TRKcnnwuh/gQYAOlahKdm8D45AAAAAElFTkSuQmCC";
	            
	            _s4CustomButtons.push({"buttonText": "Vis ejeroplysninger for adressens matrikel", "buttonImage": _s4eKnapUri, "callBack": s4DoEKnap, "searcher": "geosearcher", "target": "adresser"});
	            _s4CustomButtons.push({"buttonText": "Vis ejeroplysninger for matriklen", "buttonImage": _s4eKnapUri, "callBack": s4DoEKnap, "searcher": "geosearcher", "target": "matrikelnumre"});
            }

			function s4DoEKnap(result){
				if (result.geometry){
					
					var geojson = new OpenLayers.Format.GeoJSON();
				    var olGeom = geojson.read(result.geometry, 'Geometry');
					var pointOnSurfaceGeoJson = result.searcher.getPointOnSurface(result.geometry);
				    var pointOnSurfaceOlGeom = geojson.read(pointOnSurfaceGeoJson, 'Geometry');
			
				    //Draw point in map
				    var wkt = pointOnSurfaceOlGeom.toString();
				    cbKort.dynamicLayers.addWKT ({name: _s4Params.view.dynamiclayer, wkt:wkt, clear:true});
			
				    //Call handler
					eknap_infoHandler(pointOnSurfaceOlGeom);
			
					//Zoom to extent
				    var bounds = olGeom.getBounds();
				    var extent = 
			        {  x1: bounds.left,
			           y1: bounds.top,
			           x2: bounds.right,
			           y2: bounds.bottom
			        };   
					
					cbKort.mapObj.zoomToExtent(extent, '100');
				}
			    _s4View.blur();
			}

		[endif]
    ]]>
    </jssrc>
</tool>