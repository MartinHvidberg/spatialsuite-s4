<?xml version="1.0" encoding="UTF-8"?>
<!-- Creates a Find nearest section in detail view -->

<!-- Do not customize this tool. Make a copy of the tool and create your own tool -->
<!-- Look for Customize HERE -->
<tool type="plugin">
    <requires>
    [if: ModuleDefined("s4") ]
    	<include src="[module:s4.dir]/tools/s4-requires.xml" nodes="/tool/requires/*" mustexist="true"/>
	[endif]
	
   </requires>
    <jssrc/>
    <src><![CDATA[
    [if: ModuleDefined("s4") ]
    	if (_s4Params.indexsearcher && _s4Params.indexsearcher.enabled){
    	
    		var s4DetailsNearestIndexSearcher = new Septima.Search.S4IndexSearcher({
				//Customize HERE (What to search for)
				datasources: _s4Params.indexsearcher.datasources,
				//Example:datasources: "ds_buf_kgb_skoler",
				allowDetails: true,
	    		onSelect: function (result){
					var geojson = new OpenLayers.Format.GeoJSON();
				    var olGeom = geojson.read(result.geometry, 'Geometry');
					var wkt = olGeom.toString();
				    cbKort.dynamicLayers.addWKT ({name: _s4Params.view.dynamiclayer, wkt:wkt, clear:true});
				    cbKort.dynamicLayers.zoomTo (_s4Params.view.dynamiclayer, _s4Params.view.zoomBuffer);
	   			}				
			})
			 
			var handlerDef = s4SetupNearest([s4DetailsNearestIndexSearcher]);

			//Customize HERE (When to search)
			
			if (_s4Params.dawasearcher && _s4Params.dawasearcher.enabled){
				_s4Params.dawasearcher.searcher.addDetailHandlerDef(handlerDef);
			}
			
			//_s4Params.indexsearcher.searcher.addDetailHandlerDef(handlerDef);
			
			if (_s4Params.geosearcher && _s4Params.geosearcher.enabled){
			//	_s4Params.geosearcher.searcher.addDetailHandlerDef(handlerDef);
			}
			if (_s4Params.cvrsearcher && _s4Params.cvrsearcher.enabled){
			//	_s4Params.cvrsearcher.searcher.addDetailHandlerDef(handlerDef);
			}
		}

			//Attach Detailhandlers to s4DetailsNearestIndexSearcher
			if (typeof S4SpatialMapToolsDetailHandler !== 'undefined'){
		    	s4DetailsNearestIndexSearcher.addDetailHandlerDef({
		    		"buttonText":  cbInfo.getString('s4.details.tools'),
		    		"buttonImage": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAABJ0AAASdAHeZh94AAAAB3RJTUUH3wsEEBQCC4i3FQAAAUpJREFUOMvNlKFLREEQh7/xwFcERRBEDIIWqxjNgs1kMBuMnuH6/QNmm15QEFFBLXIIBxaLQTQopxYth+XQYFBYyywMc2/fnXDBheG9/c3Ox775DU9CCPRzDdDnlQSKyKSINEQkS+TnREQ6EiGEjgAEeAYCcA+Mmdyq6q3c2gRwV4tibKk+rvsXYKQnIFAxoE+ganKnqm8bbRhYywUCU8C3AV66fE31N73tIHADnKeAO1pwAjT1fc/kL1wrYiymgO0IADJjzD5wZABf+mwD5WQPgQdg1uwz4Mndpg7MAAvAaKEpwDRQclrdATfz3C0cGwO7TvRs409Ade/WAB6BQwet9jqHJeDdFDbjEAMHDlru1sMh4NUU/AAT7kyjqKceeKczGICPPBf13LGDrqeALWBZD813McxCr1LAFeDMf2YBtKYtWoqa/Ps/9i9UVjseslrp0QAAAABJRU5ErkJggg==",
		    		"handler": Septima.bind(S4SpatialMapToolsDetailHandler, this, {info: true, print: true})
		    	});
			}
			
    	
    	var s4NearestHoverOLids = [];
    	
    	function s4SetupNearest(searchers){
			var sqDHB = new Septima.Search.SqDetailsHandlerBuilder({
			onSelect: function (result){
				cbKort.mapObj.deleteFeature(s4NearestHoverOLids);
				s4NearestHoverOLids = [];
				var geojson = new OpenLayers.Format.GeoJSON();
				var olGeom;
				var wkt;

				olGeom = geojson.read(result.geometry, 'Geometry');
				wkt = olGeom.toString();
			    cbKort.dynamicLayers.addWKT ({name: _s4Params.view.dynamiclayer, wkt:wkt, clear:true});
			    
			    if (result.route){
				    olGeom = geojson.read(result.route.geometry, 'Geometry');
					wkt = olGeom.toString();
				    cbKort.dynamicLayers.addWKT ({name: _s4Params.view.dynamiclayer, wkt:wkt, clear:false});
				}
			    cbKort.dynamicLayers.zoomTo (_s4Params.view.dynamiclayer, _s4Params.view.zoomBuffer);
			},
			onHover: function (result){
				cbKort.mapObj.deleteFeature(s4NearestHoverOLids);
				s4NearestHoverOLids = [];
				if (result !== null){
					var geojson = new OpenLayers.Format.GeoJSON();
					var olGeom;
					var wkt;
					if (result.route){
					    olGeom = geojson.read(result.route.geometry, 'Geometry');
						wkt = olGeom.toString();
						s4NearestHoverOLids.push(cbKort.mapObj.drawWKT(wkt,
						null,
						{		styles: {
				                strokeColor: '#0470bd',
				                strokeWidth: 6,
				                strokeOpacity: 0.45
						}
						}));
					}
					
				    olGeom = geojson.read(result.geometry, 'Geometry');
					wkt = olGeom.toString();
					s4NearestHoverOLids.push(cbKort.mapObj.drawWKT(wkt,
					null,
					{		styles: {
							strokeColor: '#0470bd',
							fillColor: '#0470bd',
							fillOpacity: 0.5,
							select_pointRadius: 10,
							label: result.title
							}
					}));
				}
			},
			searchers: searchers,
			omitZeroDistance: true,
			limit: 3,
			title: cbInfo.getString('s4.nearest.caption'),
    		detailsButtonCaption: cbInfo.getString('s4.detailsbutton.caption'),
    		selectButtonCaption: cbInfo.getString('s4.showinmap.caption'),
    		header: {
    			caption: cbInfo.getString('s4.sq.header.caption'),
    			text:  cbInfo.getString('s4.sq.header.text'),
   				button: {
   					buttonText: cbInfo.getString('s4.sq.zoomtoextent'),
   					buttonImage: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB90EEg0cFwCY10wAAAOJSURBVDjL1ZRfbFN1FMdP7/21621v6taVMaUZ7DZWJLo/jmpwdIOB80VcjG8i8EYkgAkiC6RZl95i4ouJPiwZYCKLL0ZDeMHFMZj7AyHbTBjDaDQ4YTOwEtqNtbe97e/Xc3yh2m7TzEd/L7/kl/P7nO/J+Z4D8L85LcHmVd/D4fB/4liWQXc6HI5HiGjkcrn2Y8c7z3W8uSdfHLO9edvTTqfqVRTlweLiQvP3w6Nfh0IhYoyBruvAioPz+XyPaZplnHOt0uP55sfb0wMA8HtxFZIk2bJZszedNuoAgEWjp+/b7fYb4XBYAABIJXItFoNzrgEAWBmrYoxJxWWPjl0HSZIkIcR6RGRCCCDCbYhoLTBKFCKi1eVyzaRSKS0Wi7VOTozvvTx49eP213blnqhzcM7PEdEGu11JcZ5TiUAmor+EycVAv9+vbA28PJk1TTOZXNpsGMbOHybHtROdJ7+7NXXTg4g3iChQVlaWaWh86VJ5hftLWZZ/s1qtvwwPD68s+dDhoz2MsQsH3zu8z+NZ18cYMysrK595GJv3KYqSkGV5UVEcibr6hm9dLtdX1dXVZ2w22wAi5gqMEuD0ramcxWK593r77uSLdfXHamo2hZ/f8sJZzvmDwStD2fr6xne8Xm9veXnF2Xw+P8g5fxyNRpNEhP/qpQP79wMAwK93ZlgoFHIVe/H8+T5HV1eXc80ebW0JFu6K4PZXP1nm0x07WoORxOKS/E9AedkH5+jYNd7aEvQg5ocQ8a3Nz/nfOHLk/YtpI+kmoglE3DV09Uru0896xvu++NwxO/dH7tSpk9DW1gYjIyOlQK93Q38gsDVhpFJnELHJ6VQfNzQ2jiHitFaz6c6jRLwqk8m8kk4bbbenp9xC8Lc/PNE5xjnPRiIRWuFDi8XyVGx+/hIAgKIoS8/6/aMOh/MCEc1EPjoNRHS8o2OPmojHDywsJA4RkRSPxy8CQD8A5Fd0uTDbiAgba7WJqqr1vYg4AgDpJwl5U1PgA0mS7hKRhIgAAH5ElFadFABIVLjdPxGSOjd7z+vTfHe7u7uXijfP5YH+jYrieOh0qkY6bdQIkbfI8t+6SoC1mu+gpvm2JJNJtNlsqmma6QJI13XQdR32vbv351pNO5rJmOusVuYSgs9Kko2vDqzV5ojovqqqHABsACAAAHRdL06aI6KbqqqSEIIxxoQQAte8SNe6YAtxfwILoavAECTInAAAAABJRU5ErkJggg==",
   					callBack: function(sqInfo){
   						if (sqInfo.hitResults.length > 0){
	   						var geojson = new OpenLayers.Format.GeoJSON();
	   						var components = [];
	   						for (var i=0;i < sqInfo.hitResults.length;i++){
	   							components.push(geojson.read(sqInfo.hitResults[i].geometry, 'Geometry'));
	   						}
	   						components.push(geojson.read(sqInfo.mainResult.geometry, 'Geometry'));
	   						var collection = new OpenLayers.Geometry.Collection(components);
	   						collection.calculateBounds();
	   						var bounds = collection.getBounds();
						    var extent = 
					        {  x1: bounds.left,
					           y2: bounds.top,
					           x2: bounds.right,
					           y1: bounds.bottom
					        };   
							cbKort.mapObj.zoomToExtent(extent, 100);
   						}
   					}
   				}
    		},
			imageUri: _s4Params.indexsearcher.searcher.iconsMapPointGrey,
			detailsButtonCaption: cbInfo.getString('s4.detailsbutton.caption')
			});
			
			var routeApiKey = cbInfo.getParam("module.route.token");
			if (routeApiKey !== "module.route.token"){
				require(['https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.3.12/proj4.js'], Septima.bind(function (sqDHB, proj4) {
					sqDHB.addResultsProcessor(function(sqInfo){
						//{mainResult: mainResult, hitResults: allResults};
						var deferred = jQuery.Deferred();
						var crs25832 = {"type": "name", "properties": {"name": "EPSG:25832"}};
						var result = sqInfo.mainResult;
						result.geometry.crs = crs25832;
						var hitResults = sqInfo.hitResults;
						var featureCollection = {"type": "FeatureCollection", "crs": crs25832, "features": []};
						for (var i = 0; i < hitResults.length; i++){
							featureCollection.features.push({"type": "Feature", "geometry": hitResults[i].geometry});
						}
						var RouteCalculator = new Septima.Search.RouteCalculator({
							fromGeometry: result.geometry,
							toFeatureCollection: featureCollection,
							apikey: routeApiKey,
							proj4: proj4});
						
						RouteCalculator.calculate().done(Septima.bind(function(hitResults, deferred, featureCollection){
							for (var i =0;i < hitResults.length;i++){
								if (featureCollection.features[i].route){
									hitResults[i].route = featureCollection.features[i].route;
									hitResults[i].distance = featureCollection.features[i].route.dist;
								}
							}
							deferred.resolve();
						}, this, hitResults, deferred));
						
						return deferred.promise();
					});
	    		}, this, sqDHB));
			
			}

    			
			return sqDHB.buildHandlerDef();
    	}
    	Septima.Log.trace({
            eventCategory: 's4',
            eventAction: 's4_details',
            eventLabel: 'nearest-plugin'
        });
    	
	[endif]
    ]]>
    </src>
</tool>
