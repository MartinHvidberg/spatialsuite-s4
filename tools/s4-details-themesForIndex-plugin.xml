<?xml version="1.0" encoding="UTF-8"?>
<tool type="plugin">
    <requires>
    [if: ModuleDefined("s4") ]
    	<include src="[module:s4.dir]/tools/s4-requires.xml" nodes="/tool/requires/*" mustexist="true"/>
	[endif]
   </requires>
    <jssrc/>
    <src><![CDATA[
    [if: ModuleDefined("s4") ]
            if (_s4Params.indexsearcher && _s4Params.indexsearcher.enabled && _s4Params.themesearcher && _s4Params.themesearcher.enabled){
            	_s4Params.indexsearcher.searcher.addDetailHandlerDef({
            		"buttonText":  cbInfo.getString('s4.themesearcher.themes'),
            		"buttonImage": Septima.Search.s4Icons.layersIconUri,
            		"handler": Septima.bind(function(result, deferred, detailsContent){
            			var themesResults = _s4Params.themesearcher.searcher.getThemesForDatasource(result.data.datasource).getResults();
    			    	var list = {type: "list", items: []};
            			for (var i=0;i<themesResults.length;i++){
            				var themeResult = themesResults[i];
    						var icon = jQuery('<img src="' + themeResult.image + '" style="width: 20px;"/>');
    						icon.click(Septima.bind(function(result){
							        result.searcher.toggleTheme(result);
								    if (!result.data.theme.visible){
								    	cbKort.events.fireEvent('S4', {type: 'themeHit', theme: result.data});
								    }
		    						detailsContent.selectResult(result);
		    						}, this, themeResult));
		    				var extraButtonDefs = [{
		    					buttonText: cbInfo.getString('s4.detailsbutton.caption'),
		    					buttonImage: Septima.Search.icons.list.detailsIcon,
		    					callBack: Septima.bind(function(result){
		    						detailsContent.selectResult(result);
		    						}, this),
		    					fixed: true}
		    	    		];
		    	    		var title = Septima.Search.ThemeResult(themeResult, [], extraButtonDefs, {format: "compact"});
    						title.click(Septima.bind(function(result){
							        result.searcher.toggleTheme(result);
								    if (!result.data.theme.visible){
								    	cbKort.events.fireEvent('S4', {type: 'themeHit', theme: result.data});
								    }
		    						detailsContent.selectResult(result);
		    						}, this, themeResult));
    		    	    	list.items.push({type: "object", icon: icon, o1: title, hoverable: true, clickable: true});
            			}
            			
            			var output = jQuery();
            			
            			//var text = cbInfo.getString('s4.themesearcher.themesrelated');
						//output = output.add(detailsContent.formatTextArea({text: text + " " + result.title + ":"}));
            			output = output.add(detailsContent.formatList(list))
            			
    			    	deferred.resolve(output);
            		}, this),
            		isApplicable: Septima.bind(function(result){
            			var themesResults = _s4Params.themesearcher.searcher.getThemesForDatasource(result.data.datasource).getResults();
            			return themesResults.length > 0;
            		}, this),
            		getbuttonText: function(result){
            			var text = cbInfo.getString('s4.themesearcher.themesrelated');
            			return text + " " + result.title;
            		}
            	});
            }            
    	Septima.Log.trace({
            eventCategory: 's4',
            eventAction: 's4_details',
            eventLabel: 'themesForindex-plugin'
        });
    
	[endif]
    ]]>
    </src>
</tool>
